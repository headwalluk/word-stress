# word-stress Project Instructions

## Project Overview

**word-stress** is a command-line tool for stress-testing WordPress and WooCommerce sites. It measures two critical performance metrics:

1. **Steady-State Throughput**: Maximum sustained request rate with multiple parallel clients polling periodically
2. **Burst Capacity**: Maximum instantaneous load the server can handle

This helps identify performance bottlenecks, saturation points, and failure thresholds.

---

## Architecture & Design

### Test Modes

#### 1. Steady-State Testing (Default)
Multiple clients make periodic requests at a fixed interval over a duration.

**Parameters:**
- `--clients` (default: 5) - Number of parallel clients
- `--interval` (default: 1000) - Milliseconds between each client's requests
- `--duration` (default: 60) - Test duration in seconds
- `--endpoint` (default: `/`) - URL path to test
- `--method` (default: GET) - HTTP method
- `--https` (default: on) - Enable/disable HTTPS

**Behavior:**
Each client independently:
1. Makes a request
2. Waits for response (or timeout)
3. Waits until interval has elapsed since request start
4. Repeats until duration expires

**Example:**
```bash
# 5 clients × 60 requests (1000ms interval × 60s) = ~300 total requests
wordstress example.com

# WooCommerce AJAX endpoint
wordstress --clients=10 --interval=500 \
  --endpoint='/?wc-ajax=get_refreshed_fragments' --method=POST example.com
```

#### 2. Burst Testing
Simultaneous requests to measure peak instantaneous capacity.

**Parameters:**
- `--mode=burst` - Enable burst testing
- `--burst-clients` (required) - Number of simultaneous requests
- `--endpoint` (default: `/`) - URL path to test
- `--method` (default: GET) - HTTP method
- `--https` (default: on) - Enable/disable HTTPS

**Behavior:**
1. Launch all requests simultaneously
2. Measure response times and status codes
3. Record timeouts and errors
4. Report aggregate metrics

**Example:**
```bash
# 50 simultaneous requests
wordstress --mode=burst --burst-clients=50 example.com

# 1000 simultaneous AJAX requests
wordstress --mode=burst --burst-clients=1000 \
  --endpoint='/?wc-ajax=get_refreshed_fragments' --method=POST example.com
```

#### 3. Spike-and-Decay Testing (Future Enhancement)
Simulates traffic spikes that gradually tail off to a higher steady state. Useful for real-world patterns like flash sales or viral content.

### Global Parameters

- `--timeout` (default: 30000) - Request timeout in milliseconds
- `--follow-redirects` (default: true) - Follow HTTP redirects
- `--output` (default: table | options: json, csv) - Output format
- `--https` (default: on) - Enable/disable HTTPS

---

## CLI Framework Design

### Technology Stack

**Command Parsing:**
- `commander` - Industry standard, simple API, excellent for subcommands

**Interactive Prompts:**
- `inquirer` - For future interactive configuration setup

**Terminal Output:**
- `chalk` - Terminal string styling and colors
- `ora` - Progress spinners
- `cli-table3` - Pretty unicode tables for results

**Configuration:**
- `dotenv` - Load environment variables from .env files

**HTTP Requests:**
- Node.js built-in **Fetch API** - For HTTP requests (no axios needed initially)

**Logging:**
- Simple custom logger wrapping `console.log()` and `console.error()`

### Command Structure

```
wordstress <domain> [options]

Commands:
  wordstress help          Show help
  wordstress --version     Show version

Options:
  Steady-State Mode:
    --clients <n>         Number of parallel clients (default: 5)
    --interval <ms>       Request interval in ms (default: 1000)
    --duration <s>        Test duration in seconds (default: 60)
  
  Burst Mode:
    --mode=burst          Enable burst testing
    --burst-clients <n>   Number of simultaneous requests (required)
  
  Common:
    --endpoint <path>     URL path to test (default: /)
    --method <METHOD>     HTTP method (default: GET)
    --https <on|off>      Use HTTPS (default: on)
    --timeout <ms>        Request timeout (default: 30000)
    --output <format>     Output format: table|json|csv (default: table)
```

### Centralized Configuration

All environment variables and defaults are normalized in a single config module:
- Loads and validates configuration at startup
- Provides type-safe configuration object
- Makes testing easier (mock config, not `process.env`)
- Clear defaults visible in one place

**Example structure:**
```javascript
// src/config.js
module.exports = {
  // Test parameters
  clients: process.env.WS_CLIENTS || 5,
  interval: process.env.WS_INTERVAL || 1000,
  duration: process.env.WS_DURATION || 60,
  // ...
};
```

---

## Metrics & Collection

### Per-Request Metrics
- Response time (ms)
- HTTP status code
- Response size (bytes)
- Error type (timeout, network error, etc.)

### Aggregate Metrics
- Total requests sent
- Successful responses (2xx, 4xx, 5xx counts and percentages)
- Timeout count
- Response time percentiles (min, max, avg, median, P95, P99)
- Requests per second (actual throughput)
- Total data transferred
- Test duration

### Future Enhancements
- Time-series data (response times over time)
- Error rate degradation patterns
- Throughput trends

---

## Output Format

### Default: Console Tables

Pretty-formatted output showing:
- Test configuration summary
- Status code distribution table
- Response time statistics table
- Throughput metrics

**Example:**
```
═══════════════════════════════════════════════════════
  Stress Test Results
═══════════════════════════════════════════════════════

Target: https://example.com
Test Mode: Steady-State
Duration: 60.2s
Clients: 5
Interval: 1000ms
Total Requests: 300

┌─────────────────────┬──────────────┐
│ Metric              │ Value        │
├─────────────────────┼──────────────┤
│ Successful (2xx)    │ 298 (99.3%)  │
│ Client Error (4xx)  │ 0 (0%)       │
│ Server Error (5xx)  │ 2 (0.7%)     │
│ Timeouts            │ 0 (0%)       │
└─────────────────────┴──────────────┘

Response Times (ms):
┌─────────┬──────────┐
│ Min     │ 89       │
│ Max     │ 2156     │
│ Avg     │ 245      │
│ Median  │ 198      │
│ P95     │ 567      │
│ P99     │ 1234     │
└─────────┴──────────┘

Throughput: 4.98 req/s
Data Transferred: 2.1 MB
```

### JSON Export
Machine-readable format for analysis tools and spreadsheets.

### CSV Export
For spreadsheet analysis and comparing multiple test runs.

---

## Implementation Decisions

### Decision: Fetch API over Axios
**Rationale:** Node.js now has built-in Fetch API support. Start with built-in to minimize dependencies. Switch to axios only if we need advanced features (interceptors, request/response transformation).

### Decision: Simple Logger over Winston/Pino
**Rationale:** Avoid heavy logging frameworks. Implement a simple custom logger wrapping `console.log()` and `console.error()` with `LOG_LEVEL` support. Keeps the project lightweight.

### Decision: Table Output First, Live UI Later
**Rationale:** Start with simple final-report tables using `cli-table3`. Live updating UI deferred to future enhancement. Reduces initial complexity while still providing useful output.

### Decision: No Authentication in Phase 1
**Rationale:** Test AJAX endpoints and public endpoints without authentication. Authentication support (basic auth, cookies, tokens) deferred to future phases.

### Decision: Metrics Streaming, Not Stored
**Rationale:** Don't store full response bodies or all request details in memory. Calculate percentiles and aggregate metrics incrementally. Save memory for long-running tests.

---

## Development Workflows

### Adding a New Test Mode

1. Add mode to CLI with `commander` in `src/cli/commands.js`
2. Create test mode class in `src/test-modes/` (e.g., `SpikeDayTestMode.js`)
3. Implement `run()` method that:
   - Spawns clients/requests
   - Collects metrics
   - Returns aggregated results
4. Add test mode to factory in `src/test-modes/factory.js`
5. Document in `.instructions.md` and `dev-notes/02-stress-test-requirements.md`

### Adding a New Output Format

1. Create formatter in `src/formatters/` (e.g., `XMLFormatter.js`)
2. Implement `format(results)` method
3. Add formatter to factory in `src/formatters/factory.js`
4. Update CLI `--output` options

### Adding Metrics Collection

1. Update `MetricsCollector` class
2. Add per-request metric calculation
3. Update aggregate calculation
4. Update output formatters to display new metrics

---

## Module Structure (Planned)

```
src/
├── bin/wordstress              # Executable entry point
├── cli/
│   ├── commands.js             # Commander.js setup
│   └── help.js                 # Help text
├── config.js                   # Centralized configuration
├── test-modes/
│   ├── SteadyStateTestMode.js  # Steady-state implementation
│   ├── BurstTestMode.js        # Burst implementation
│   └── factory.js              # Test mode factory
├── http/
│   └── client.js               # HTTP request handling
├── metrics/
│   └── MetricsCollector.js     # Metrics aggregation
├── formatters/
│   ├── TableFormatter.js       # Pretty table output
│   ├── JsonFormatter.js        # JSON export
│   ├── CsvFormatter.js         # CSV export
│   └── factory.js              # Formatter factory
├── logger.js                   # Custom logger
└── main.js                     # Application entry point
```

---

## Error Handling

### Request Errors
- Network errors → Record as "Network Error"
- Timeouts → Record as timeout, increment timeout counter
- HTTP errors (4xx, 5xx) → Record status code, count by category

### Behavior
- Continue testing even if individual requests fail
- Never abort test due to errors
- Track and report error patterns

### Reporting
- Distinguish error types in output
- Report error percentages
- Highlight concerning error patterns (e.g., >10% error rate)

---

## Testing & Quality

### Unit Tests
- Test metrics calculation (percentiles, aggregates)
- Test formatters with sample data
- Test configuration validation

### Integration Tests
- Mock HTTP requests, test full test-mode flow
- Test CLI parameter parsing
- Test output formatting

### Manual Testing
- Run against local WordPress/WooCommerce installation
- Verify steady-state behavior matches expectations
- Verify burst requests all send simultaneously
- Verify output formatting accuracy

---

## Next Steps

1. ✅ Define requirements and test modes
2. ✅ Select dependencies
3. ✅ Design CLI interface
4. → Set up CLI framework with commander
5. → Implement HTTP client with Fetch API
6. → Implement steady-state test mode
7. → Implement burst test mode
8. → Build metrics collector
9. → Create output formatters
10. → Add comprehensive testing
